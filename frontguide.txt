================================================================================
    CogX Backend API - Next.js Frontend Development Guide
================================================================================

Project: CogX - Cognitive Games Platform
Backend: ASP.NET Core (.NET 10) with SignalR
Target Framework: Next.js (React)
Last Updated: 2024

================================================================================
TABLE OF CONTENTS
================================================================================

1. Project Overview
2. Backend Architecture
3. API Base URL Configuration
4. Required Dependencies
5. REST API Endpoints Reference
6. SignalR WebSocket Integration
7. Data Models (DTOs)
8. Complete Implementation Examples
9. Testing the Backend
10. Common Issues & Troubleshooting
11. Environment Setup Checklist

================================================================================
1. PROJECT OVERVIEW
================================================================================

CogX is a multiplayer cognitive games platform supporting:
- Tic-Tac-Toe (Morpion)
- Speed Typing
- Connect 4 (Puissance4)

The backend provides:
- REST API for game management (lobbies, players, leaderboard)
- SignalR WebSocket Hubs for real-time gameplay
- SQL Server database for persistence
- CORS enabled for local development

================================================================================
2. BACKEND ARCHITECTURE
================================================================================

Technology Stack:
- Framework: ASP.NET Core (.NET 10)
- Database: SQL Server (LocalDB)
- Real-time: SignalR
- ORM: Entity Framework Core

Port Configuration:
- HTTPS: https://localhost:7049
- HTTP: http://localhost:5000 (if configured)

CORS Policy:
- Name: "DevelopmentCorsPolicy"
- Currently accepts ALL origins in development
- Allows credentials (required for SignalR)
- ‚ö†Ô∏è WARNING: Must be restricted in production!

Database:
- Connection: Server=(localdb)\mssqllocaldb;Database=CogXDb
- Migrations: Applied automatically
- Provider: SQL Server

================================================================================
3. API BASE URL CONFIGURATION
================================================================================

Create environment variables in Next.js:

--- .env.local ---
NEXT_PUBLIC_API_URL=https://localhost:7049
NEXT_PUBLIC_WS_URL=wss://localhost:7049
------------------

Usage in code:
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL;
const WS_BASE_URL = process.env.NEXT_PUBLIC_WS_URL;

Example API call:
fetch(`${API_BASE_URL}/api/player`)

Example WebSocket connection:
new HubConnectionBuilder()
  .withUrl(`${WS_BASE_URL}/lobbyhub`)

================================================================================
4. REQUIRED DEPENDENCIES
================================================================================

Install these npm packages:

--- Core Dependencies ---
npm install @microsoft/signalr axios

--- TypeScript Support (Recommended) ---
npm install --save-dev @types/node

--- Optional (State Management) ---
npm install zustand  # or redux-toolkit

Package Details:

1. @microsoft/signalr
   - SignalR client for JavaScript/TypeScript
   - Used for WebSocket connections to game hubs
   - Version: Latest stable

2. axios
   - HTTP client for REST API calls
   - Alternative: native fetch API
   - Provides better error handling

3. zustand (optional)
   - Simple state management
   - Store player info, game state, lobby data

================================================================================
5. REST API ENDPOINTS REFERENCE
================================================================================

Base URL: https://localhost:7049/api

--------------------------------------------------------------------------------
5.1 PLAYER ENDPOINTS
--------------------------------------------------------------------------------

GET /api/player
  Description: Get all players (paginated)
  Query Params: ?limit=100 (optional)
  Response: List<PlayerDto>
  Example:
    GET https://localhost:7049/api/player?limit=50

POST /api/player
  Description: Create a new player
  Body: { "pseudo": "string" }
  Response: PlayerDto { id: Guid, pseudo: string }
  Example:
    POST https://localhost:7049/api/player
    Body: { "pseudo": "JohnDoe" }

GET /api/player/{id}
  Description: Get player by ID
  Path Params: id (Guid)
  Response: PlayerDto
  Example:
    GET https://localhost:7049/api/player/123e4567-e89b-12d3-a456-426614174000

DELETE /api/player/{id}
  Description: Delete player (GDPR compliance)
  Path Params: id (Guid)
  Response: 200 OK
  Example:
    DELETE https://localhost:7049/api/player/123e4567-e89b-12d3-a456-426614174000

--------------------------------------------------------------------------------
5.2 LOBBY ENDPOINTS
--------------------------------------------------------------------------------

GET /api/lobby
  Description: Get all public lobbies waiting for players
  Query Params: ?gameType=Morpion (optional)
  Response: List<LobbyDto>
  Game Types: "Morpion", "SpeedTyping", "Puissance4"
  Example:
    GET https://localhost:7049/api/lobby?gameType=Morpion

GET /api/lobby/{id}
  Description: Get lobby details
  Path Params: id (Guid)
  Query Params: ?playerId=<guid> (required)
  Response: LobbyDetailsDto
  Example:
    GET https://localhost:7049/api/lobby/abc-123?playerId=def-456

GET /api/lobby/{id}/players
  Description: Get all players in a lobby
  Path Params: id (Guid)
  Response: List<PlayerDto>
  Example:
    GET https://localhost:7049/api/lobby/abc-123/players

POST /api/lobby
  Description: Create a new lobby
  Body: CreateLobbyRequest
    {
      "playerId": "guid",
      "gameType": "string",
      "maxPlayers": int,
      "password": "string" (optional)
    }
  Response: { "lobbyId": "guid", "shareLink": "string" }
  Example:
    POST https://localhost:7049/api/lobby
    Body:
    {
      "playerId": "123e4567-e89b-12d3-a456-426614174000",
      "gameType": "Morpion",
      "maxPlayers": 2,
      "password": null
    }

POST /api/lobby/{id}/join
  Description: Join an existing lobby
  Path Params: id (Guid)
  Body: { "playerId": "guid", "password": "string" (optional) }
  Response: 200 OK
  Example:
    POST https://localhost:7049/api/lobby/abc-123/join
    Body: { "playerId": "def-456" }

POST /api/lobby/{id}/leave
  Description: Leave a lobby before game starts
  Path Params: id (Guid)
  Body: "guid" (playerId as raw JSON string)
  Response: 200 OK
  Note: If host leaves, lobby is deleted
  Example:
    POST https://localhost:7049/api/lobby/abc-123/leave
    Body: "123e4567-e89b-12d3-a456-426614174000"

POST /api/lobby/{id}/start
  Description: Start the game (host only)
  Path Params: id (Guid)
  Body: "guid" (hostId as raw JSON string)
  Response: { "gameSessionId": "guid" }
  Example:
    POST https://localhost:7049/api/lobby/abc-123/start
    Body: "123e4567-e89b-12d3-a456-426614174000"

DELETE /api/lobby/{id}
  Description: Delete lobby (host only)
  Path Params: id (Guid)
  Query Params: ?hostId=<guid>
  Response: 200 OK
  Example:
    DELETE https://localhost:7049/api/lobby/abc-123?hostId=def-456

--------------------------------------------------------------------------------
5.3 LEADERBOARD ENDPOINTS
--------------------------------------------------------------------------------

GET /api/leaderboard/{gameType}
  Description: Get leaderboard for a game type
  Path Params: gameType (Morpion|SpeedTyping|Puissance4)
  Query Params: ?top=10&playerId=<guid> (optional)
  Response: LeaderboardResponse
  Example:
    GET https://localhost:7049/api/leaderboard/Morpion?top=10

GET /api/leaderboard/games
  Description: Get statistics for all games
  Response: List<GameStatsDto>
  Example:
    GET https://localhost:7049/api/leaderboard/games

GET /api/leaderboard/player/{playerId}
  Description: Get player's game history
  Path Params: playerId (Guid)
  Query Params: ?gameType=Morpion (optional)
  Response: List<LeaderboardDto>
  Example:
    GET https://localhost:7049/api/leaderboard/player/abc-123?gameType=Morpion

POST /api/leaderboard
  Description: Add a score to leaderboard
  Body: AddScoreRequest
    {
      "playerId": "guid",
      "gameType": "string",
      "score": int,
      "gameSessionId": "guid"
    }
  Response: LeaderboardDto
  Example:
    POST https://localhost:7049/api/leaderboard
    Body:
    {
      "playerId": "123e4567-e89b-12d3-a456-426614174000",
      "gameType": "Morpion",
      "score": 100,
      "gameSessionId": "abc-123"
    }

DELETE /api/leaderboard/player/{playerId}
  Description: Delete all scores for a player (GDPR)
  Path Params: playerId (Guid)
  Response: { "deleted": int }
  Example:
    DELETE https://localhost:7049/api/leaderboard/player/abc-123

--------------------------------------------------------------------------------
5.4 ADMIN ENDPOINTS (Optional)
--------------------------------------------------------------------------------

GET /api/admin/game-history/{sessionId}
  Description: Get complete game history
  Path Params: sessionId (Guid)
  Response: GameHistoryResponse

GET /api/admin/game-sessions
  Description: Get all game sessions
  Query Params: ?gameType=Morpion&limit=50
  Response: List<GameSessionSummaryDto>

GET /api/admin/player-actions/{playerId}
  Description: Get all actions by a player
  Path Params: playerId (Guid)
  Query Params: ?gameSessionId=<guid> (optional)
  Response: List<GameActionDto>

GET /api/admin/export/{sessionId}
  Description: Export game session as JSON file
  Path Params: sessionId (Guid)
  Response: File download (application/json)

GET /api/admin/platform-stats
  Description: Get platform-wide statistics
  Response: PlatformStatsDto

DELETE /api/admin/game-history/{sessionId}
  Description: Delete game history (GDPR)
  Path Params: sessionId (Guid)
  Response: { "deleted": int }

================================================================================
6. SIGNALR WEBSOCKET INTEGRATION
================================================================================

--------------------------------------------------------------------------------
6.1 SETUP SIGNALR CONNECTION
--------------------------------------------------------------------------------

Basic connection setup:

--- app/lib/signalr.ts ---
import * as signalR from '@microsoft/signalr';

export function createHubConnection(hubPath: string) {
  const connection = new signalR.HubConnectionBuilder()
    .withUrl(`${process.env.NEXT_PUBLIC_WS_URL}${hubPath}`, {
      skipNegotiation: true,
      transport: signalR.HttpTransportType.WebSockets
    })
    .withAutomaticReconnect()
    .configureLogging(signalR.LogLevel.Information)
    .build();

  return connection;
}
--------------------------

Connection lifecycle:

1. Create connection
2. Register event handlers (.on())
3. Start connection (.start())
4. Invoke methods (.invoke())
5. Close connection (.stop())

--------------------------------------------------------------------------------
6.2 LOBBY HUB (/lobbyhub)
--------------------------------------------------------------------------------

Hub URL: wss://localhost:7049/lobbyhub

Methods to Invoke:
- JoinLobbyGroup(string lobbyId)
- LeaveLobbyGroup(string lobbyId)
- SubscribeToLobbyList()
- UnsubscribeFromLobbyList()

Events to Listen:
- LobbyCreated ‚Üí { LobbyDto }
- LobbyDeleted ‚Üí { lobbyId: string }
- PlayerJoined ‚Üí { PlayerDto }
- PlayerLeft ‚Üí { PlayerDto }
- GameStarted ‚Üí { gameType, gameSessionId, players }
- LobbyClosed ‚Üí { reason: string }

Example Usage:

const lobbyConnection = createHubConnection('/lobbyhub');

// Register event handlers
lobbyConnection.on('LobbyCreated', (lobby) => {
  console.log('New lobby:', lobby);
  // Update lobby list in state
});

lobbyConnection.on('PlayerJoined', (player) => {
  console.log('Player joined:', player);
  // Update player list
});

lobbyConnection.on('GameStarted', (data) => {
  console.log('Game starting:', data);
  // Navigate to game page
  router.push(`/game/${data.gameType}?session=${data.gameSessionId}`);
});

// Start connection
await lobbyConnection.start();

// Subscribe to lobby list updates
await lobbyConnection.invoke('SubscribeToLobbyList');

// Join a specific lobby's group
await lobbyConnection.invoke('JoinLobbyGroup', lobbyId);

// Cleanup
await lobbyConnection.invoke('LeaveLobbyGroup', lobbyId);
await lobbyConnection.stop();

--------------------------------------------------------------------------------
6.3 TIC-TAC-TOE HUB (/tictactoehub)
--------------------------------------------------------------------------------

Hub URL: wss://localhost:7049/tictactoehub

Methods to Invoke:
- JoinGameRoom(string lobbyId)
- LeaveGameRoom(string lobbyId)
- InitializeGame(string lobbyId, Guid gameSessionId, List<Guid> playerIds)
- MakeMove(string lobbyId, Guid gameSessionId, Guid playerId, int row, int col)
- GetGameState(Guid gameSessionId) ‚Üí Returns TicTacToeGameDto
- Forfeit(string lobbyId, Guid gameSessionId, Guid playerId)

Events to Listen:
- TicTacToeInitialized ‚Üí { gameState: TicTacToeGameDto }
- MoveMade ‚Üí { gameState: TicTacToeGameDto }
- GameOver ‚Üí { winner, gameState }
- InvalidMove ‚Üí { reason: string }
- GameError ‚Üí { error: string }
- PlayerForfeited ‚Üí { playerId, winnerId }

Example Usage:

const gameConnection = createHubConnection('/tictactoehub');

gameConnection.on('TicTacToeInitialized', (gameState) => {
  setBoard(gameState.board);
  setCurrentPlayer(gameState.currentPlayerId);
});

gameConnection.on('MoveMade', (gameState) => {
  setBoard(gameState.board);
  setCurrentPlayer(gameState.currentPlayerId);
});

gameConnection.on('GameOver', (result) => {
  if (result.winner) {
    alert(`Winner: ${result.winner}`);
  } else {
    alert('Draw!');
  }
});

await gameConnection.start();
await gameConnection.invoke('JoinGameRoom', lobbyId);
await gameConnection.invoke('InitializeGame', lobbyId, gameSessionId, playerIds);

// When player clicks a cell
async function handleCellClick(row, col) {
  await gameConnection.invoke('MakeMove', lobbyId, gameSessionId, playerId, row, col);
}

--------------------------------------------------------------------------------
6.4 SPEED TYPING HUB (/speedtypinghub)
--------------------------------------------------------------------------------

Hub URL: wss://localhost:7049/speedtypinghub

Methods to Invoke:
- JoinGameRoom(string lobbyId)
- LeaveGameRoom(string lobbyId)
- InitializeGame(string lobbyId, Guid gameSessionId, List<Guid> playerIds)
- StartRace(string lobbyId, Guid gameSessionId)
- UpdateProgress(string lobbyId, Guid gameSessionId, Guid playerId, 
                 int charactersTyped, int errorCount)
- GetGameState(Guid gameSessionId) ‚Üí Returns SpeedTypingGameDto

Events to Listen:
- SpeedTypingInitialized ‚Üí { text, players }
- Countdown ‚Üí { count: int } (3, 2, 1)
- RaceStarted ‚Üí { startTime }
- ProgressUpdated ‚Üí { playerId, progress, errorCount }
- PlayerFinished ‚Üí { playerId, time, accuracy }
- RaceEnded ‚Üí { rankings }
- RaceTimeout ‚Üí { rankings }
- GameError ‚Üí { error: string }

Example Usage:

const typingConnection = createHubConnection('/speedtypinghub');

typingConnection.on('Countdown', (data) => {
  setCountdown(data.count);
});

typingConnection.on('RaceStarted', () => {
  setIsRacing(true);
  setStartTime(Date.now());
});

typingConnection.on('ProgressUpdated', (data) => {
  updatePlayerProgress(data.playerId, data.progress);
});

await typingConnection.start();
await typingConnection.invoke('JoinGameRoom', lobbyId);
await typingConnection.invoke('InitializeGame', lobbyId, gameSessionId, playerIds);
await typingConnection.invoke('StartRace', lobbyId, gameSessionId);

// On typing input change
function handleTyping(currentInput) {
  const typed = currentInput.length;
  const errors = calculateErrors(currentInput, targetText);
  
  typingConnection.invoke('UpdateProgress', 
    lobbyId, gameSessionId, playerId, typed, errors);
}

--------------------------------------------------------------------------------
6.5 CONNECT 4 HUB (/connect4hub)
--------------------------------------------------------------------------------

Hub URL: wss://localhost:7049/connect4hub

Methods to Invoke:
- JoinGameRoom(string lobbyId)
- LeaveGameRoom(string lobbyId)
- InitializeGame(string lobbyId, Guid gameSessionId, List<Guid> playerIds)
- DropPiece(string lobbyId, Guid gameSessionId, Guid playerId, int column)
- GetGameState(Guid gameSessionId) ‚Üí Returns Connect4GameDto
- Forfeit(string lobbyId, Guid gameSessionId, Guid playerId)

Events to Listen:
- Connect4Initialized ‚Üí { gameState: Connect4GameDto }
- PieceDropped ‚Üí { gameState: Connect4GameDto }
- GameOver ‚Üí { winner, gameState }
- InvalidMove ‚Üí { reason: string }
- GameError ‚Üí { error: string }
- PlayerForfeited ‚Üí { playerId, winnerId }

Example Usage:

const connect4Connection = createHubConnection('/connect4hub');

connect4Connection.on('Connect4Initialized', (gameState) => {
  setBoard(gameState.board); // 6 rows x 7 columns
  setCurrentPlayer(gameState.currentPlayerId);
});

connect4Connection.on('PieceDropped', (gameState) => {
  setBoard(gameState.board);
  setCurrentPlayer(gameState.currentPlayerId);
});

await connect4Connection.start();
await connect4Connection.invoke('JoinGameRoom', lobbyId);
await connect4Connection.invoke('InitializeGame', lobbyId, gameSessionId, playerIds);

// When player clicks a column
async function handleColumnClick(column) {
  await connect4Connection.invoke('DropPiece', 
    lobbyId, gameSessionId, playerId, column);
}

================================================================================
7. DATA MODELS (DTOs)
================================================================================

--------------------------------------------------------------------------------
7.1 PLAYER DTOS
--------------------------------------------------------------------------------

PlayerDto {
  id: string (Guid)
  pseudo: string
}

CreatePlayerRequest {
  pseudo: string
}

--------------------------------------------------------------------------------
7.2 LOBBY DTOS
--------------------------------------------------------------------------------

LobbyDto {
  id: string (Guid)
  gameType: string
  hostPseudo: string
  currentPlayers: number
  maxPlayers: number
  isPrivate: boolean
}

LobbyDetailsDto {
  id: string (Guid)
  gameType: string
  players: PlayerDto[]
  maxPlayers: number
  isHost: boolean
  status: string
}

CreateLobbyRequest {
  playerId: string (Guid)
  gameType: string
  maxPlayers: number
  password?: string
}

CreateLobbyResponse {
  lobbyId: string (Guid)
  shareLink: string
}

JoinLobbyRequest {
  playerId: string (Guid)
  password?: string
}

--------------------------------------------------------------------------------
7.3 GAME DTOS
--------------------------------------------------------------------------------

TicTacToeGameDto {
  gameSessionId: string (Guid)
  board: string[][] (3x3, values: null | playerId)
  currentPlayerId: string (Guid)
  players: PlayerDto[]
  status: string
  winner?: string (Guid)
}

SpeedTypingGameDto {
  gameSessionId: string (Guid)
  text: string
  players: {
    playerId: string
    progress: number
    errorCount: number
    finished: boolean
  }[]
  status: string
  rankings: {
    playerId: string
    time: number
    accuracy: number
  }[]
}

Connect4GameDto {
  gameSessionId: string (Guid)
  board: string[][] (6x7, values: null | playerId)
  currentPlayerId: string (Guid)
  players: PlayerDto[]
  status: string
  winner?: string (Guid)
}

--------------------------------------------------------------------------------
7.4 LEADERBOARD DTOS
--------------------------------------------------------------------------------

LeaderboardDto {
  id: string (Guid)
  playerId: string (Guid)
  playerPseudo: string
  gameType: string
  score: number
  achievedAt: string (ISO date)
}

LeaderboardResponse {
  leaderboard: LeaderboardDto[]
  playerRank?: {
    rank: number
    score: number
  }
}

AddScoreRequest {
  playerId: string (Guid)
  gameType: string
  score: number
  gameSessionId: string (Guid)
}

GameStatsDto {
  gameType: string
  totalGames: number
  totalPlayers: number
  averageScore: number
}

================================================================================
8. COMPLETE IMPLEMENTATION EXAMPLES
================================================================================

--------------------------------------------------------------------------------
8.1 EXAMPLE: PLAYER CREATION
--------------------------------------------------------------------------------

--- app/components/PlayerSetup.tsx ---
'use client';
import { useState } from 'react';
import axios from 'axios';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default function PlayerSetup({ onPlayerCreated }) {
  const [pseudo, setPseudo] = useState('');
  const [loading, setLoading] = useState(false);

  const handleCreatePlayer = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await axios.post(`${API_URL}/api/player`, {
        pseudo: pseudo
      });

      const player = response.data;
      
      // Store player info in localStorage
      localStorage.setItem('playerId', player.id);
      localStorage.setItem('playerPseudo', player.pseudo);

      onPlayerCreated(player);
    } catch (error) {
      console.error('Error creating player:', error);
      alert('Failed to create player');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleCreatePlayer}>
      <input
        type="text"
        value={pseudo}
        onChange={(e) => setPseudo(e.target.value)}
        placeholder="Enter your pseudo"
        required
        minLength={3}
      />
      <button type="submit" disabled={loading}>
        {loading ? 'Creating...' : 'Create Player'}
      </button>
    </form>
  );
}
--------------------------------------

--------------------------------------------------------------------------------
8.2 EXAMPLE: LOBBY LIST WITH SIGNALR
--------------------------------------------------------------------------------

--- app/components/LobbyList.tsx ---
'use client';
import { useState, useEffect } from 'react';
import axios from 'axios';
import * as signalR from '@microsoft/signalr';

const API_URL = process.env.NEXT_PUBLIC_API_URL;
const WS_URL = process.env.NEXT_PUBLIC_WS_URL;

export default function LobbyList() {
  const [lobbies, setLobbies] = useState([]);
  const [connection, setConnection] = useState(null);

  useEffect(() => {
    // Fetch initial lobbies
    fetchLobbies();

    // Setup SignalR connection
    const hubConnection = new signalR.HubConnectionBuilder()
      .withUrl(`${WS_URL}/lobbyhub`)
      .withAutomaticReconnect()
      .build();

    // Register event handlers
    hubConnection.on('LobbyCreated', (lobby) => {
      setLobbies(prev => [...prev, lobby]);
    });

    hubConnection.on('LobbyDeleted', (lobbyId) => {
      setLobbies(prev => prev.filter(l => l.id !== lobbyId));
    });

    // Start connection and subscribe
    hubConnection.start()
      .then(() => {
        console.log('Connected to LobbyHub');
        hubConnection.invoke('SubscribeToLobbyList');
      })
      .catch(err => console.error('Error connecting:', err));

    setConnection(hubConnection);

    // Cleanup
    return () => {
      if (hubConnection) {
        hubConnection.invoke('UnsubscribeFromLobbyList');
        hubConnection.stop();
      }
    };
  }, []);

  const fetchLobbies = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/lobby`);
      setLobbies(response.data);
    } catch (error) {
      console.error('Error fetching lobbies:', error);
    }
  };

  const handleJoinLobby = async (lobbyId) => {
    const playerId = localStorage.getItem('playerId');
    
    try {
      await axios.post(`${API_URL}/api/lobby/${lobbyId}/join`, {
        playerId: playerId
      });
      
      // Navigate to lobby page
      window.location.href = `/lobby/${lobbyId}`;
    } catch (error) {
      console.error('Error joining lobby:', error);
      alert(error.response?.data || 'Failed to join lobby');
    }
  };

  return (
    <div>
      <h2>Available Lobbies</h2>
      {lobbies.length === 0 ? (
        <p>No lobbies available</p>
      ) : (
        <ul>
          {lobbies.map(lobby => (
            <li key={lobby.id}>
              <strong>{lobby.gameType}</strong> - 
              Host: {lobby.hostPseudo} - 
              Players: {lobby.currentPlayers}/{lobby.maxPlayers}
              {lobby.isPrivate && ' üîí'}
              <button onClick={() => handleJoinLobby(lobby.id)}>
                Join
              </button>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
-------------------------------------

--------------------------------------------------------------------------------
8.3 EXAMPLE: CREATE LOBBY
--------------------------------------------------------------------------------

--- app/components/CreateLobby.tsx ---
'use client';
import { useState } from 'react';
import axios from 'axios';
import { useRouter } from 'next/navigation';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default function CreateLobby() {
  const [gameType, setGameType] = useState('Morpion');
  const [maxPlayers, setMaxPlayers] = useState(2);
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleCreateLobby = async (e) => {
    e.preventDefault();
    setLoading(true);

    const playerId = localStorage.getItem('playerId');
    
    if (!playerId) {
      alert('Please create a player first');
      return;
    }

    try {
      const response = await axios.post(`${API_URL}/api/lobby`, {
        playerId: playerId,
        gameType: gameType,
        maxPlayers: maxPlayers,
        password: password || null
      });

      const { lobbyId } = response.data;
      router.push(`/lobby/${lobbyId}`);
    } catch (error) {
      console.error('Error creating lobby:', error);
      alert('Failed to create lobby');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleCreateLobby}>
      <label>
        Game Type:
        <select value={gameType} onChange={(e) => setGameType(e.target.value)}>
          <option value="Morpion">Tic-Tac-Toe</option>
          <option value="SpeedTyping">Speed Typing</option>
          <option value="Puissance4">Connect 4</option>
        </select>
      </label>

      <label>
        Max Players:
        <input
          type="number"
          value={maxPlayers}
          onChange={(e) => setMaxPlayers(parseInt(e.target.value))}
          min="2"
          max="10"
        />
      </label>

      <label>
        Password (optional):
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          placeholder="Leave empty for public"
        />
      </label>

      <button type="submit" disabled={loading}>
        {loading ? 'Creating...' : 'Create Lobby'}
      </button>
    </form>
  );
}
--------------------------------------

--------------------------------------------------------------------------------
8.4 EXAMPLE: TIC-TAC-TOE GAME
--------------------------------------------------------------------------------

--- app/game/tictactoe/page.tsx ---
'use client';
import { useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import * as signalR from '@microsoft/signalr';

const WS_URL = process.env.NEXT_PUBLIC_WS_URL;

export default function TicTacToePage() {
  const searchParams = useSearchParams();
  const sessionId = searchParams.get('session');
  const lobbyId = searchParams.get('lobby');

  const [board, setBoard] = useState(Array(3).fill(null).map(() => Array(3).fill(null)));
  const [currentPlayer, setCurrentPlayer] = useState(null);
  const [connection, setConnection] = useState(null);
  const [gameOver, setGameOver] = useState(false);
  const [winner, setWinner] = useState(null);

  const playerId = typeof window !== 'undefined' 
    ? localStorage.getItem('playerId') 
    : null;

  useEffect(() => {
    if (!sessionId || !lobbyId) return;

    const hubConnection = new signalR.HubConnectionBuilder()
      .withUrl(`${WS_URL}/tictactoehub`)
      .withAutomaticReconnect()
      .build();

    // Register event handlers
    hubConnection.on('TicTacToeInitialized', (gameState) => {
      console.log('Game initialized:', gameState);
      setBoard(gameState.board);
      setCurrentPlayer(gameState.currentPlayerId);
    });

    hubConnection.on('MoveMade', (gameState) => {
      console.log('Move made:', gameState);
      setBoard(gameState.board);
      setCurrentPlayer(gameState.currentPlayerId);
    });

    hubConnection.on('GameOver', (result) => {
      console.log('Game over:', result);
      setGameOver(true);
      setWinner(result.winner);
      setBoard(result.gameState.board);
    });

    hubConnection.on('InvalidMove', (data) => {
      alert(`Invalid move: ${data.reason}`);
    });

    // Start connection
    hubConnection.start()
      .then(() => {
        console.log('Connected to TicTacToeHub');
        return hubConnection.invoke('JoinGameRoom', lobbyId);
      })
      .then(() => {
        // Game should already be initialized by host via LobbyHub
        return hubConnection.invoke('GetGameState', sessionId);
      })
      .then((gameState) => {
        if (gameState) {
          setBoard(gameState.board);
          setCurrentPlayer(gameState.currentPlayerId);
        }
      })
      .catch(err => console.error('Error:', err));

    setConnection(hubConnection);

    return () => {
      if (hubConnection) {
        hubConnection.invoke('LeaveGameRoom', lobbyId);
        hubConnection.stop();
      }
    };
  }, [sessionId, lobbyId]);

  const handleCellClick = async (row, col) => {
    if (gameOver || !connection) return;
    if (currentPlayer !== playerId) {
      alert('Not your turn!');
      return;
    }
    if (board[row][col] !== null) {
      alert('Cell already occupied!');
      return;
    }

    try {
      await connection.invoke('MakeMove', lobbyId, sessionId, playerId, row, col);
    } catch (error) {
      console.error('Error making move:', error);
    }
  };

  const renderCell = (row, col) => {
    const value = board[row][col];
    return (
      <button
        onClick={() => handleCellClick(row, col)}
        disabled={gameOver || value !== null}
        style={{
          width: '80px',
          height: '80px',
          fontSize: '24px'
        }}
      >
        {value ? (value === playerId ? 'X' : 'O') : ''}
      </button>
    );
  };

  return (
    <div>
      <h1>Tic-Tac-Toe</h1>
      
      {gameOver ? (
        <h2>{winner ? (winner === playerId ? 'You Won!' : 'You Lost!') : 'Draw!'}</h2>
      ) : (
        <h2>{currentPlayer === playerId ? 'Your Turn' : "Opponent's Turn"}</h2>
      )}

      <div style={{ display: 'inline-block' }}>
        {board.map((row, rowIndex) => (
          <div key={rowIndex} style={{ display: 'flex' }}>
            {row.map((_, colIndex) => (
              <div key={colIndex}>{renderCell(rowIndex, colIndex)}</div>
            ))}
          </div>
        ))}
      </div>
    </div>
  );
}
-------------------------------------

--------------------------------------------------------------------------------
8.5 EXAMPLE: LEADERBOARD
--------------------------------------------------------------------------------

--- app/components/Leaderboard.tsx ---
'use client';
import { useState, useEffect } from 'react';
import axios from 'axios';

const API_URL = process.env.NEXT_PUBLIC_API_URL;

export default function Leaderboard({ gameType = 'Morpion' }) {
  const [leaderboard, setLeaderboard] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchLeaderboard();
  }, [gameType]);

  const fetchLeaderboard = async () => {
    try {
      const response = await axios.get(
        `${API_URL}/api/leaderboard/${gameType}?top=10`
      );
      setLeaderboard(response.data.leaderboard);
    } catch (error) {
      console.error('Error fetching leaderboard:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <p>Loading...</p>;

  return (
    <div>
      <h2>{gameType} Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Score</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {leaderboard.map((entry, index) => (
            <tr key={entry.id}>
              <td>{index + 1}</td>
              <td>{entry.playerPseudo}</td>
              <td>{entry.score}</td>
              <td>{new Date(entry.achievedAt).toLocaleDateString()}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
--------------------------------------

================================================================================
9. TESTING THE BACKEND
================================================================================

--------------------------------------------------------------------------------
9.1 VERIFY BACKEND IS RUNNING
--------------------------------------------------------------------------------

1. Start the backend:
   - Open the project in Visual Studio
   - Press F5 or click "Start Debugging"
   - Wait for the console to show "Now listening on: https://localhost:7049"

2. Test in browser:
   Open: https://localhost:7049/swagger
   
   You should see Swagger UI with all API endpoints documented.

3. Test a simple endpoint:
   Open: https://localhost:7049/api/player
   
   Should return an empty array [] or list of players.

--------------------------------------------------------------------------------
9.2 TEST WITH CURL
--------------------------------------------------------------------------------

Create a player:
curl -X POST https://localhost:7049/api/player \
  -H "Content-Type: application/json" \
  -d "{\"pseudo\": \"TestPlayer\"}" \
  --insecure

Get all players:
curl https://localhost:7049/api/player --insecure

Create a lobby:
curl -X POST https://localhost:7049/api/lobby \
  -H "Content-Type: application/json" \
  -d "{\"playerId\": \"YOUR_PLAYER_ID\", \"gameType\": \"Morpion\", \"maxPlayers\": 2}" \
  --insecure

Note: --insecure flag is needed for self-signed SSL certificate

--------------------------------------------------------------------------------
9.3 TEST WITH POSTMAN
--------------------------------------------------------------------------------

1. Import collection (or create manually):
   - Base URL: https://localhost:7049
   - Disable SSL verification (Settings > General > SSL certificate verification)

2. Test sequence:
   a. POST /api/player ‚Üí Save the returned ID
   b. POST /api/player ‚Üí Save second player ID
   c. POST /api/lobby ‚Üí Use first player ID, save lobby ID
   d. POST /api/lobby/{id}/join ‚Üí Use second player ID
   e. GET /api/lobby/{id} ‚Üí Verify both players are in lobby
   f. POST /api/lobby/{id}/start ‚Üí Use first player ID (host)

3. Test SignalR (requires SignalR client):
   - Use "Simple WebSocket Client" browser extension
   - Connect to: wss://localhost:7049/lobbyhub
   - SignalR uses a specific protocol, recommend using JavaScript client

================================================================================
10. COMMON ISSUES & TROUBLESHOOTING
================================================================================

--------------------------------------------------------------------------------
10.1 SSL CERTIFICATE ERRORS
--------------------------------------------------------------------------------

Problem: "SSL certificate problem" or "CERT_AUTHORITY_INVALID"

Solutions:
1. For development, disable SSL verification:
   - Axios: Use https.Agent with rejectUnauthorized: false
   - Fetch: Add process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0' (NOT for production)

2. Trust the development certificate:
   - Windows: Certificate is automatically trusted by .NET
   - Make sure to access via https://localhost:7049 not http://

3. Use HTTP instead (not recommended):
   - Modify backend Program.cs to use HTTP
   - Update frontend to use http://localhost:5000

--------------------------------------------------------------------------------
10.2 CORS ERRORS
--------------------------------------------------------------------------------

Problem: "CORS policy: No 'Access-Control-Allow-Origin' header"

Solutions:
1. Verify backend is running with CORS enabled (it is by default)

2. Make sure you're using credentials:
   - Axios: { withCredentials: true }
   - Fetch: { credentials: 'include' }

3. Check browser console for specific CORS error details

4. Verify frontend is not using 127.0.0.1 (use localhost consistently)

--------------------------------------------------------------------------------
10.3 SIGNALR CONNECTION FAILS
--------------------------------------------------------------------------------

Problem: "Failed to start connection: Error: WebSocket failed to connect"

Solutions:
1. Verify WebSocket URL is correct: wss://localhost:7049/lobbyhub

2. Check if backend is running and accessible

3. Ensure skipNegotiation is true and transport is WebSockets:
   .withUrl(url, {
     skipNegotiation: true,
     transport: signalR.HttpTransportType.WebSockets
   })

4. Check browser console for detailed error messages

5. Try without skipNegotiation to see if negotiation works

--------------------------------------------------------------------------------
10.4 DATABASE ERRORS
--------------------------------------------------------------------------------

Problem: "A network-related or instance-specific error occurred while establishing a connection to SQL Server"

Solutions:
1. Install SQL Server LocalDB:
   - Download SQL Server Express
   - Or use Visual Studio installer to add LocalDB

2. Verify connection string in appsettings.json

3. Run migrations:
   - Open Package Manager Console in Visual Studio
   - Run: Update-Database

4. Check if database exists:
   - Open SQL Server Object Explorer in Visual Studio
   - Connect to (localdb)\mssqllocaldb
   - Look for CogXDb database

--------------------------------------------------------------------------------
10.5 404 NOT FOUND
--------------------------------------------------------------------------------

Problem: API endpoints return 404

Solutions:
1. Verify correct URL format:
   - Correct: https://localhost:7049/api/player
   - Incorrect: https://localhost:7049/player

2. Check if backend is running

3. Verify port number (7049 is default HTTPS)

4. Check Swagger to see available endpoints

--------------------------------------------------------------------------------
10.6 SIGNALR EVENTS NOT RECEIVED
--------------------------------------------------------------------------------

Problem: Event handlers not firing

Solutions:
1. Register event handlers BEFORE starting connection:
   connection.on('EventName', handler);
   await connection.start();

2. Verify event names match exactly (case-sensitive)

3. Check if you've joined the correct group:
   await connection.invoke('JoinLobbyGroup', lobbyId);

4. Add logging to verify connection state:
   connection.onclose(() => console.log('Disconnected'));

5. Check browser console for errors

================================================================================
11. ENVIRONMENT SETUP CHECKLIST
================================================================================

Backend Requirements:
‚ñ° .NET 10 SDK installed
‚ñ° Visual Studio 2022 (or VS Code with C# extension)
‚ñ° SQL Server LocalDB installed
‚ñ° Backend project builds successfully
‚ñ° Backend runs on https://localhost:7049
‚ñ° Swagger UI accessible at /swagger
‚ñ° Database migrations applied (CogXDb exists)

Frontend Requirements:
‚ñ° Node.js 18+ installed
‚ñ° Next.js project created
‚ñ° @microsoft/signalr package installed
‚ñ° axios package installed
‚ñ° Environment variables configured (.env.local)
‚ñ° NEXT_PUBLIC_API_URL=https://localhost:7049
‚ñ° NEXT_PUBLIC_WS_URL=wss://localhost:7049

Testing Checklist:
‚ñ° Can create a player via POST /api/player
‚ñ° Can fetch players via GET /api/player
‚ñ° Can create a lobby via POST /api/lobby
‚ñ° Can see lobbies via GET /api/lobby
‚ñ° Can connect to SignalR LobbyHub
‚ñ° Receive LobbyCreated events
‚ñ° Can join a lobby via POST /api/lobby/{id}/join
‚ñ° Can start a game via POST /api/lobby/{id}/start
‚ñ° Can connect to game-specific hub (e.g., TicTacToeHub)
‚ñ° Can make moves and receive game state updates

Development Workflow:
1. Start backend (F5 in Visual Studio)
2. Verify Swagger is accessible
3. Start frontend (npm run dev)
4. Open browser to http://localhost:3000
5. Test player creation
6. Test lobby creation and joining
7. Test game functionality
8. Monitor browser console and network tab for errors

Production Preparation:
‚ñ° Change CORS policy to restrict origins
‚ñ° Add authentication (JWT tokens)
‚ñ° Use production database (not LocalDB)
‚ñ° Enable HTTPS with valid certificate
‚ñ° Add rate limiting
‚ñ° Add input validation
‚ñ° Add error logging (Serilog, Application Insights)
‚ñ° Add health checks
‚ñ° Configure environment-specific settings
‚ñ° Test on production-like environment

================================================================================
QUICK START GUIDE
================================================================================

Minimal steps to get started:

1. Backend Setup (5 minutes):
   - Open CogX.sln in Visual Studio
   - Press F5 to run
   - Verify https://localhost:7049/swagger opens

2. Frontend Setup (10 minutes):
   - Create Next.js app: npx create-next-app@latest cogx-frontend
   - Install: npm install @microsoft/signalr axios
   - Create .env.local with API URLs
   - Copy example components from section 8

3. Test Basic Flow (5 minutes):
   - Create player
   - Create lobby
   - Join lobby with second player
   - Start game
   - Play game

Total time: ~20 minutes for basic setup

================================================================================
ADDITIONAL RESOURCES
================================================================================

ASP.NET Core Documentation:
https://docs.microsoft.com/aspnet/core

SignalR Documentation:
https://docs.microsoft.com/aspnet/core/signalr

SignalR JavaScript Client:
https://docs.microsoft.com/aspnet/core/signalr/javascript-client

Next.js Documentation:
https://nextjs.org/docs

Entity Framework Core:
https://docs.microsoft.com/ef/core

================================================================================
SUPPORT & CONTACT
================================================================================

For issues or questions:
1. Check this documentation first
2. Review browser console and network tab
3. Check backend logs in Visual Studio output window
4. Verify API using Swagger UI
5. Test individual endpoints with Postman/curl

GitHub Repository:
https://github.com/raidBer/CogX

================================================================================
END OF DOCUMENTATION
================================================================================

Last Updated: 2024
Version: 1.0
Backend Version: .NET 10
Target Framework: Next.js 14+

This documentation is intended for frontend developers building a Next.js
application that connects to the CogX backend API. For backend development
or API modifications, refer to the source code and inline documentation.
